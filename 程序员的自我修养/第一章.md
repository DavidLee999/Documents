# 计算机的软硬件体系

最关键三部分：

- 中央处理器 CPU；
- 内存 ROM；
- I/O 控制芯片；

## 总体架构

早期计算机都连接在一个**总线** (bus) 上。如下图所示：

![屏幕快照 2018-08-05 16.03.11](屏幕快照 2018-08-05 16.03.11.png)

随着CPU 越来越快，采用**倍频**的方式和系统总线进行通信。

> 倍频：系统总线以一个较低的频率工作（外频）。而CPU 的工作频率=*倍频 x 外频*。
>
> CPU 的默认倍频只有一个，主板必须支持该倍频数。

为了维持CPU 和系统总线的I/O，又设计了高速的**北桥芯片**和低速的**南桥芯片**。

>北桥芯片：负责CPU 和内存（主要），南桥芯片和图形设备间的通信；
>
>南桥芯片：负责外部I/O，IDE 的控制等等。



![屏幕快照 2018-08-05 16.11.57](屏幕快照 2018-08-05 16.11.57.png)

## 处理器

多CPU 计算机的常见形式有**对称多处理器** (SMP)，即每个CPU 在系统中的地位和作用是一样的。

由于多芯片太过昂贵，又有了多核处理器。

参考：[free lunch is over](http://www.gotw.ca/publications/concurrency-ddj.htm).

## 层次结构

整个计算机体系结构都是按照严格的层次结构设计的。层之间使用**接口**进行通信。

每个层都是对她下面那层的包装和扩展。

## 操作系统

### CPU

让CPU 充分运行的三种方法：

1. **多道程序** (multiprogramming)：利用一个**监控程序**，发现某个程序暂时无需使用CPU 时就把其他的等待程序载入。
2. **分时系统** (Time-Sharing System)：每个程序运行一段时间后都主动让出CPU 交给其他程序。（但程序可以一直霸占CPU 不出让。）
3. **多任务系统** (Multi-task)：系统运行在**受硬件保护**的级别，程序以**进程** (Process) 的方式运行。每个进程有自己独立的地址空间，CPU 由操作系统**统一分配**（抢占式 (Preemptive)）。

### 设备驱动

操作系统通过驱动程序实现对硬件的管理。相关的设备驱动程序由硬件厂家提供并满足规定的接口。

### 内存

#### 连续单一内存

在这种管理方式中，内存被分为两个区域：**系统区**和**用户区**。应用程序装入到用户区，可使用用户区全部空间。其特点是，最简单，适用于单用户、单任务的操作系统。

#### 分区式存储管理

为了支持**多道程序系统**和**分时系统**，支持**并发**，引入了分区式存储管理。它把内存分为一些大小相等或不等的分区，操作系统占用其中一个分区，其余的分区由应用程序使用。每个应用程序占用一个或几个分区。

分区式存储管理虽然可以支持并发，但难以进行内存分区的共享。并引入了**内碎片**和**外碎片**.

- 内碎片：占用分区内未被利用的空间。
- 外碎片：占用分区之间难以利用的空闲分区。

##### 固定分区

固定式分区的**特点**是把内存划分为若干个固定大小的连续分区。

- 优点：易于实现，开销小；
- 缺点：内碎片；分区数固定；

##### 动态分区

动态创建分区：在装入程序时按其初始要求分配，或在其执行过程中通过系统调用进行分配或改变分区大小。

- 缺点：没有内碎片，但引入了外碎片。

分区分配：

- 最先适配法：按分区先后次序查找。分区分配和释放的时间性能较好，较大的空闲分区可以被保留在内存高端。但随着低端分区不断划分会产生较多小分区，每次分配时查找时间开销便会增大。
- 下次适配法：即从上次分配的分区开始查找。可以使空闲分区的分布更均匀，但较大的分区不容易保留。
- 最佳适配法：找内存大小与要求相差最小的空闲分区进行分配。从整体看会造成较多的外碎片。
- 最坏适配法：找到最大的空闲分区进行分配。

##### 伙伴系统

在伙伴系统，无论已分配分区或空闲分区，其大小均为 2 的 k 次幂，k 为整数。

当要进行内存分配时，找到适当大小的空闲分区进行分配。如果最佳大2^n^的分区已经用完，就向上查找2^n+1^ 大小的分区，将之**分裂**为两个2^n^ 大小的分区并打上伙伴标记。当其中一个被应用程序用完后即和其伙伴合并。

##### 内存紧缩

将各个占用分区向内存一端移动，然后将各个空闲分区合并成为一个空闲分区。

缺点：

- 对占用分区进行内存数据搬移占用CPU时间；
- 如果对占用分区中的程序进行“浮动”，则其重定位需要硬件支持。

紧缩时机：

1. 每个分区释放之后；
2. 在可用分区不够之后在进行紧缩。

#### 覆盖与交换技术

##### 覆盖技术

**原理**：一个程序的几个代码段或数据段，按照时间先后来占用公共的内存空间。将程序必要部分的代码和数据常驻内存；可选部分平时存放在外存(覆盖文件)中，在需要时才装入内存。不存在调用关系的模块不必同时装入到内存，从而可以相互覆盖。

![1350357539_7229](1350357539_7229.png)

缺点：编程时必须划分程序模块和确定程序模块之间的覆盖关系。只能在同一进程内进行。

##### 交换技术

**原理**：在多个程序并发执行时，可以将暂时不能执行的程序（进程）送到外存中，从而获得空闲内存空间来装入其他程序（进程）。

优点：增加并发程序数目；不影响程序结构。

缺点：换入换出造成程序开销。

##### 小结

以上技术使用的地址都是物理地址。包含了几个缺点：

- 地址空间不隔离；
- 内存使用效率低；
- 程序运行地址不确定。

**解决**：增加中间层，即采用虚拟地址技术。

这样，就有两种地址：**虚拟地址空间**和**物理地址空间**。

#### 分段

在段式存储管理中，将程序的地址空间划分为若干个段(segment)，这样每个进程有一个二维的地址空间。每个段分配一个连续的分区，而进程中的各个段可以不连续地存放在内存的不同分区中。

在为某个段分配物理内存时，可以采用首先适配法、下次适配法、最佳适配法等方法。在回收某个段所占用的空间时，要注意将收回的空间与其相邻的空间合并。

但程序通过分段划分为多个模块，如代码段、数据段、共享段。**优点**是：

- 可以分别编写和编译源程序的一个文件；
- 可以针对不同类型的段采取不同的保护，也可以按段为单位来进行共享。
- 没有内碎片，可以通过内存紧缩消除外碎片。

##### 数据结构

操作系统需要一定的数据结构来实现**进程的地址空间**到**物理内存空间**的**映射**，并跟踪物理内存的使用情况，以便在装入新的段的时候，合理地分配内存空间。

1. 进程段表：包含*段号*和*段内索引*。