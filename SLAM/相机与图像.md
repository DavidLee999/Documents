# 相机与图像

前面我们讨论了机器人位姿的表示和对其进行优化的工具，相当于是SLAM 中运动方程的部分。这一讲我们讨论视觉SLAM 中的观测方程，相机模型和对应的图像表示。

## 相机模型

相机拍照，是将三维世界中的一个三维点映射到对应的二维影像平面的过程。这个过程能够用一个**几何模型**来进行描述。在各种各样的模型中，最简单也最常用的就是**针孔相机模型**，也叫**针孔模型**。这个模型较为简单，而由于相机镜头上**透镜**的存在，成像的过程中会有**畸变**产生。为此，需要另外对畸变进行建模。

### 针孔相机模型

初中物理里都会有一个小孔成像的实验，这个小孔成像的模型可以看作是针孔相机模型的基础。

![屏幕快照 2018-02-04 15.14.17](/Users/lipenghua/Downloads/屏幕快照 2018-02-04 15.14.17.png)

这里盗图一张，来自高博的《视觉slam十四讲》

如上图所示，**相机坐标系**为O-x-y-z，想象人站在相机后面，O 为相机光心，z轴指向相机前方，x 轴向右而y 轴向下。真实世界中的一个点P，经过小孔O 投影后，落在物理成像平面O'-x'-y' （也称像平面坐标系）上，称为像点P'。

假设P在**相机坐标系**下的坐标为[X, Y, Z]^T^，P' 为[X', Y', Z']^T^，焦距为f。根据相似三角形有：
$$
\frac{Z}{f} = -\frac{X}{X^\prime}=-\frac{Y}{Y^\prime}
$$
其中，负号表示所成的像是**倒立**的。

习惯上把成像平面对称到相机的前方，再整理一下上式即可得：
$$
X^\prime = f \frac{X}{Z}\\
Y^\prime = f \frac{Y}{Z}
$$
至此，我们描述了点P 和它的像之间的空间关系。在数码相机中，我们最终得到的是由一个个像素组成的数字影像，这需要在成像平面上进行**采样**和**量化**。这里就不针对二者进行介绍了。

在物理成像平面上定义一个**像素坐标系** o'-u-v。一样地想象人站在相机之后，其原点o' 位于图像的左上角，u轴向右和x 轴平行，v 轴向下和y 轴平行。假设P' 的**像素坐标**为[u, v]^T^。像素坐标系和物理成像平面O'-x'-y' 之间相差**缩放**和**平移**。因此，假设像素坐标在u轴上缩放了$\alpha$ 倍，在v 轴上缩放$\beta$ 倍。同事，二者之间的平移量为[c~x~, c~y~]^T^。那么，P' 在物理成像平面下的坐标和其像素坐标间的关系为：
$$
u=\alpha X^\prime+c_z \\
v = \beta Y^\prime + c_y
$$
将式(2) 代入并**把$\alpha f$ 合并成$f_x$，把$\beta f$ 合并成$f_y$**（这也是x 轴上的焦距和y 轴上的焦距不同的原因），可得：
$$
u=f_x \frac{X}{Z} +c_x\\
v = f_y \frac{Y}{Z}+c_y
$$
上式就是相机坐标系下，一个空间点的三维坐标到其对应像点到像素坐标到转换关系。其中，f 的单位为米，$\alpha，\beta$ 的单位为像素/米。

利用齐次坐标，将上市写成矩阵形式可得：
$$
\begin{pmatrix}
u \\ v \\ 1
\end{pmatrix}=\frac{1}{Z}
\begin{pmatrix}
f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1\\
\end{pmatrix}
\begin{pmatrix}
X \\ Y \\ Z
\end{pmatrix}=\frac{1}{Z} \mathbf{K}\mathbf{P}
$$
上式中，**K** 称为**相机矩阵**或者**内参数矩阵**，因为它包含的都是相机的参数。一般习惯把Z 放在左侧，计算完后再对结果除以其第三个值以得到像素坐标。通常认为相机矩阵在出厂之后是固定的并由厂家给出。如果没有则可以对相机进行**标定**以得到相机内参。

注意一直到这里，我们都没有涉及到相机的位姿**T**，因为我们一直在相机坐标系下。相机的位姿描述了相机在世界坐标系下的位置和姿态，也**给出了世界坐标系到相机坐标系的变换关系**。举例来说，对于一组照片，如果取第一张照片对应的相机坐标系为世界坐标系，则对应的相机位姿为旋转矩阵为单位阵而平移向量为0。而其他照片对应的相机位姿为该世界坐标系下的坐标到该照片对应的相机坐标系下的坐标的变换关系。

由于相机在运动，所以点P 的相机坐标应该是它的世界坐标，记作**P~w~**，根据相机当前的位姿变换到相机坐标系下的结果。
$$
Z\mathbf{P}_{uv}=Z\begin{bmatrix}
u \\ v \\ 1
\end{bmatrix}
=\mathbf{K}(\mathbf{R}\mathbf{P}_w+\mathbf{t}) = \mathbf{K}\mathbf{T}\mathbf{P}_w
$$
上式使用了齐次坐标并且包含了一次齐次坐标到非齐次坐标的变换。其中，**R**，**t** 或着**T **表示相机的外参数，它会随着相机的运动而发生改变，是SLAM 过程中待估计的目标，表示着机器人的轨迹。最后，上式的**T** 为**T~cw~**，表示世界坐标系到相机坐标系的变换，其转置为**T~wc~**。

注意到齐次坐标乘上一个非零常数后表示的是同一个点，所以可以把上市左侧中的Z 去掉。
$$
\mathbf{P}_{uv}=\mathbf{K}\mathbf{T}\mathbf{P}_w
$$
前面我们提到这个式子包含一次齐次坐标到非齐次坐标的变换。因为右侧的**TP~w~** 是一个4维向量。将之除以最后一维得到相机坐标系下的三维坐标（这个过程也叫归一化处理）。对于这个三维向量，按照齐次坐标的方式，可以再对其最后一维进行**归一化处理**，就得到了P 在**相机归一化平面** 上的投影：
$$
\tilde{\mathbf{P}}=\begin{bmatrix}
X \\ Y \\ Z
\end{bmatrix} = (\mathbf{T}\mathbf{P}_w)_{1:3},\ \ \mathbf{P}_c=\begin{bmatrix} \frac{X}{Z} \\ \frac{Y}{Z} \\ 1 \end{bmatrix}
$$
此时，**P~c~** 可以看成是一个二维的齐次坐标，称为**归一化坐标**。它可以看成是位于相机前方z = 1 处的平面上，该平面称为**归一化平面**。P~c~ 经过相机内参后就得到了像素坐标，所以可以**把像素坐标[u, v]^T^ 看成是归一化平面上的点进行量化测量**的结果。

![屏幕快照 2018-02-04 17.26.41](/Users/lipenghua/Downloads/屏幕快照 2018-02-04 17.26.41.png)

这一小节我们介绍了相机模型和各个坐标系的转换关系。其中涉及了世界坐标系，相机坐标系，归一化坐标，像平面坐标系和像素坐标系。要注意它们之间的区别和两两之间的转换关系。

### 畸变

为了获得好的成像效果，一般会在相机前方加上各种透镜。这就会对光线的传播产生新的影响：

- **透镜自身**对光线传播的影响；
- 由于**机械组装**中的误差，导致**透镜和称像平面不完全平行**而产生的误差。

第一种原因引起的畸变称为**径向畸变**。因为在实际的加工过程中，透镜一般是**中心对称**的，这就使得这种畸变通常也是径向对称。它主要分为两大类：**桶形畸变**和**枕形畸变**。

![屏幕快照 2018-02-04 17.27.34](/Users/lipenghua/Downloads/屏幕快照 2018-02-04 17.27.34.png)

可以看大，桶形畸变是由图像的放大率随着光轴之间的距离增加而减小；枕形畸变则相反。它们是径向畸变，因此穿过图像中心和光轴有交点的直线能保持形状不变。