# 非线性优化

在SLAM 中，由于噪声的影响，观测方程和运动方程都只能近似成立。但在整个过程中，会有很多多余观测，即一个特征会被机器人在不同位置、不同时间进行观测，每次也都会观测到多个特征，这就形成了约束。利用这些约束，就可以对数据进行优化。

## 状态估计问题

###问题的引出

一个经典的SLAM 模型由一个运动方程和一个观测方程组成：
$$
\begin{cases}
\mathbf{x}_k=f(\mathbf{x}_{k-1},\mathbf{u}_k)+\omega_k \\
\mathbf{z}_{k,j}=h(\mathbf{y}_j,\mathbf{x}_k) + v_{k,j}
\end{cases}
$$
注意，这里上一时刻的位姿$\mathbf{x}_{k-1}$ 是已知的；第j 个路标的观测值$\mathbf{z}_j$ 和机器人运动测量值$\mathbf{u}_k$ 是观测值；最后两项是噪声。而未知值是此刻的位姿$\mathbf{x}_{k}$ 和路标的世界坐标$\mathbf{y}_{j}$。

通过上一讲我们知道，相机的位姿可以用$\mathbf{T}_k$ 或者$\exp(\xi_k^\wedge)$ 来表达，设相机矩阵为**K**，观测值**z** 为对应路标的像素坐标，观测方程就可以写为：
$$
s\mathbf{z}_{k,j}=\mathbf{K}\exp(\xi^\wedge)\mathbf{y}_j
$$
s 为路标$\mathbf{z}_j$ 在对应相机坐标系下的深度。这里我们使用了齐次坐标并包含有一次齐次到非齐次的坐标转换。作为引出这里先不展开，后面会详细解释。

如前所述，由于噪声的存在，这个式子只能在数学上成立。实际中必须在后面加上一个噪声项v。通常都假设两个方程的噪声都满足**零均值的高斯分布**：
$$
\omega_k \sim N(0, \mathbf{R}_k),\ \mathbf{v}_k\sim N(0,\mathbf{Q}_{k, j})
$$
在这些噪声的影响下，我们希望通过带噪声的数据**z** 和**u** 来推断位姿**x** 和地图**y**，这就构成了一个状态估计问题。常用的方法有滤波器和非线性优化。滤波器会在后面结束，这里重点介绍非线性优化的方法。

### 最大后验和最大似然

我们从概率学的角度检视下这个状态估计问题。在非线性优化中，所有待优化的变量都放在一个*状态变量*中：
$$
\mathbf{x}=\{\mathbf{x}_1,\ldots\mathbf{x}_N,\mathbf{y}_1,\ldots\mathbf{y}_M\}
$$
表示包含了N 个时刻的相机位姿和M 个路标。而对机器人状态的估计，就是已知输入数据**u** 和观测数据**z** 的条件下，求状态**x** 的条件概率分布：
$$
P(\mathbf{x}|\mathbf{z},\mathbf{u})
$$
如果我们并没有测量运动的传感器，如IMU等，只考虑视觉部分，则上式就变成了$P(\mathbf{x}|\mathbf{z})$。利用贝叶斯法则可得：
$$
P(\mathbf{x}|\mathbf{z})=\frac{P(\mathbf{z}|\mathbf{x})P(\mathbf{x})}{P(\mathbf{z})}\propto P(\mathbf{z}|\mathbf{x})P(\mathbf{x})
$$
等式的左侧称为**后验概率**，P(**x**) 和P(**z**) 是先验概率，P(**z**|**x**) 称为似然。先验概率一般通过观测频率而得到。而P(**z**) 和状态变量**x** 无关（一般也为固定值），所以略去。**直接去求解后验分布一般比较困难，但是求一个状态最有顾忌，使得在该状态下后验概率最大化 (MAP)，则是可行的**。
$$
\mathbf{x}^*_{MAP}=\arg \max P(\mathbf{x}|\mathbf{z})=\arg \max P(\mathbf{z}|\mathbf{x})P(\mathbf{x})
$$
从上式可以看到，求解最大后验概率相当于**最大化似然和先验概率的乘积**。更进一步地，我们可以说：呃，其实我也不太知道机器人现在大概在什么地方哎。此时连先验概率P(**x**) 也可以忽略（P(**x**) 一般可由之前的状态估计得到，在这一步中一般也是一个固定值，忽略了也没影响）。那么，问题就变成了**求解x 的最大似然估计 (MLE)**：
$$
x^*_{MLE}=\arg\max P(\mathbf{z}|\mathbf{x})
$$
从概率的角度来说，上式就是*在事件**x** 已经发生的情况下，事件**z** 发生的概率*。代入到SLAM 的背景中，似然就指*在现有的位姿下，能够产生什么样的观测数据*。前面说过，**z** 才是已知量，所以上式应该理解成*在什么样的位姿下，可以产生现在这些观测数据*。

## 最小二乘法

### 引出

回顾上一节的观测模型：
$$
\mathbf{z}_{k,j}=h(\mathbf{y}_j,\mathbf{x}_k) + \mathbf{v}_{k,j}
$$
我们假设了噪声项满足零均值的高斯分布：
$$
\mathbf{v}_k\sim N(0,\mathbf{Q}_{k, j})
$$
要注意的是，式(9) 的前半部分并不包含任何概率项，而是噪声项**v** 引入了概率（高斯分布）。所以，式(9) 相当于把零均值的高斯分布平移了一段$h(\mathbf{y}_j,\mathbf{x}_k)$。所以，观测数据的条件概率为：
$$
P(\mathbf{z}_{j,k}|\mathbf{x}_k,\mathbf{y}_j) = N(h(\mathbf{y}_j,\mathbf{x}_k), \mathbf{Q}_{k, j}))
$$
即为均值为$h(\mathbf{y}_j,\mathbf{x}_k)$ 的高斯分布。为了计算使它最大化的$\mathbf{x}_k,\mathbf{y}_j$，可以使用**最小化负对数**的方法。

考虑任意维的高斯分布$\mathbf{x}_k\sim N(\mu,\mathbf{\Sigma})$ (这里**x** 不表示位姿)，它的概率密度函数为：
$$
P(\mathbf{x})=\frac{1}{\sqrt{(2\pi)^N\det(\mathbf{\Sigma})}}\exp(-\frac{1}{2}(\mathbf{x}-\mu)^T\mathbf{\Sigma}^{-1}(\mathbf{x}-\mu))
$$
取其负对数可得：
$$
-\ln(P(\mathbf{x}))=\frac{1}{2}\ln((2\pi)^N\det(\mathbf{\Sigma}))+\frac{1}{2}(\mathbf{x}-\mu)^T\mathbf{\Sigma}^{-1}(\mathbf{x}-\mu)
$$
求原分布的最大化显然就是求其负对数的**最小化**。而上式第一项和**x** 无关，所以只需要最小化右侧的二次型项。将之代入式(8) 可得：
$$
\mathbf(x)^*_{MLE}=\arg\min (\mathbf{z}_{k,j}-h(\mathbf{y}_j,\mathbf{x}_k))^T\mathbf{\Sigma}^{-1}(\mathbf{z}_{k,j}-h(\mathbf{y}_j,\mathbf{x}_k))
$$
该式就相当于**最小化噪声项的平方**。

